# 📋 Project Development Rules

> **Purpose**: Establish development standards and rules for this project  
> **Reference**: FHEVM Development Standards & Solutions Manual (Version 6.0)

---

## 🎯 Core Principles

1. **Dual-Contract Architecture**: Always implement both FHE and Mock versions
2. **Progressive Development**: Start with Mock, then upgrade to FHE
3. **Gateway Stability**: Implement timeout, retry, and graceful degradation
4. **Wallet Compatibility**: Support both OKX and MetaMask
5. **Code Language**: All code and UI must be in English
6. **Error Handling**: Comprehensive error handling for all operations

---

## 📚 Reference Documentation

### Primary Reference ⭐ **最高优先级**
- **FHEVM Development Standards Manual**: 
  - Location: `FHEVM_开发标准与解决方案手册.md`（项目根目录）
  - Version: 6.1（包含 Sepolia FHEVM 最新配置）
  - Usage: **遇到任何问题时，必须先查阅此手册！**
  - Key Sections:
    - **2.6**: Sepolia FHEVM 正确配置（2025年最新API）⭐
    - **3.5**: 前端加密创建标准实现 ⭐
    - **12.3 A**: 动态ABI配置（解决函数签名冲突）
    - **12.4**: 常见问题速查表 ⭐
    - **8-11**: Competition Guide
  - **使用工具**: 使用 `codebase_search` 在手册中搜索相关关键词

### Project Documentation
- `README.md`: Project overview and goals
- `update_debug_log.md`: Issue tracking and solutions
- `自查日志.md`: Operation history and progress
- `docs/REFERENCE.md`: Quick reference to manual sections

---

## 🛠️ Development Standards

### Smart Contract
- ✅ Use Solidity ^0.8.24
- ✅ Inherit from `GatewayCaller` for FHE contracts
- ✅ Implement state enums (not raw integers)
- ✅ Add request mapping system
- ✅ Set `CALLBACK_GAS_LIMIT >= 500000`
- ✅ Emit events for all critical operations
- ✅ Implement timeout and retry mechanisms

### Frontend
- ✅ Use React ^18.2.0
- ✅ Use Vite ^5.4.21
- ✅ Use ethers.js v6 (not v5)
- ✅ Use `@zama-fhe/relayer-sdk` for encryption
- ✅ Separate read/write operations (public RPC for reads)
- ✅ Use `window.ethereum.request` for OKX compatibility
- ✅ Implement Gateway polling with timeout
- ✅ All UI text in English

### Gateway Integration
- ✅ Polling interval: 5 seconds
- ✅ Max attempts: 60 (5 minutes total)
- ✅ Implement async processing (don't block UI)
- ✅ Handle 404 responses (not ready yet)
- ✅ Handle timeout gracefully
- ✅ Implement retry mechanism

### Wallet Compatibility
- ✅ Use `window.ethereum.request` for transactions (OKX)
- ✅ Explicitly set `from` address in transaction params
- ✅ Use public RPC for read operations
- ✅ Use public RPC for transaction confirmation polling
- ✅ Handle BigInt conversion: `Number(bigint.toString())`

---

## 🚨 问题解决优先级规则 ⭐ **重要！**

### 第一优先级：查阅项目手册（必须）

**遇到任何技术问题时，必须先查阅手册！**

- **手册位置**: `FHEVM_开发标准与解决方案手册.md`（项目根目录）
- **手册版本**: 6.1（包含 Sepolia FHEVM 最新配置）
- **使用方法**: 
  1. 使用 `codebase_search` 工具在手册中搜索相关问题
  2. 查找对应章节（见下面的快速参考）
  3. 按照手册中的步骤操作
  4. 在回复中引用手册的具体章节号

**重要章节快速参考**:
- **Sepolia FHEVM 配置问题** → 第2.6节（2025年最新API）
- **智能合约问题** → 第2节
- **前端开发问题** → 第3节（加密、解密、Gateway轮询）
- **ABI 函数签名冲突** → 第12.3 A节（动态ABI）
- **Gateway 问题** → 第4节、第10节
- **钱包兼容性问题** → 第6节
- **常见错误速查** → 第12.4节
- **部署问题** → 第12.5节
- **架构设计** → 第12节

**必须查阅手册的情况**:
1. ❗ 遇到任何错误或异常（必须先在手册中查找）
2. ❗ 配置问题（Hardhat、Vite、环境变量等）
3. ❗ API使用问题（合约调用、加密、解密等）
4. ❗ 部署问题
5. 开始新功能开发前
6. 架构设计决策时

**⚠️ 禁止行为**:
- ❌ 不要跳过手册直接猜测解决方案
- ❌ 不要重复解决手册中已有的问题
- ❌ 不要在未查阅手册的情况下提供解决方案

### 第二优先级：项目文档

- `docs/PROBLEM_SOLVING_GUIDE.md` - 问题解决指南（新）
- `docs/REFERENCE.md` - 快速参考
- `docs/DEPLOYMENT.md` - 部署指南
- `update_debug_log.md` - 调试日志
- `自查日志.md` - 操作历史

### 第三优先级：外部资源

仅当前面所有资源都无法解决问题时，才查看外部资源或询问用户。

---

## 📖 Manual Quick Reference（手册快速参考）

**Always consult the manual when**:
1. Starting a new feature
2. Encountering any error ⭐ **必须**
3. Implementing Gateway integration
4. Handling wallet compatibility issues
5. Designing architecture decisions
6. Writing tests
7. Preparing for deployment

**Manual Quick Reference**:
- Smart Contract issues → Section 2, **2.6** (Sepolia配置)
- Frontend issues → Section 3
- ABI/Function signature issues → Section 12.3 A (动态ABI)
- Gateway issues → Section 4, 10
- Wallet issues → Section 6
- Competition requirements → Section 8
- Architecture patterns → Section 1, 12
- Common errors → Section 12.4 (速查表)

---

## 📝 Update Requirements

### Before Starting Work
- [ ] **优先查阅手册** (`FHEVM_开发标准与解决方案手册.md`) ⭐
  - 使用 `codebase_search` 搜索相关问题
  - 查找对应章节的解决方案
- [ ] Check `update_debug_log.md` for similar issues
- [ ] Update `自查日志.md` with planned changes

### During Development
- [ ] Follow code standards from manual
- [ ] Add comments for complex logic
- [ ] Test with both OKX and MetaMask

### After Completing Work
- [ ] Update `自查日志.md` with completed changes
- [ ] Update `update_debug_log.md` if issues encountered
- [ ] Verify all tests pass
- [ ] Update documentation if needed

---

## 🎯 Competition Requirements

### Must-Have (Hard Requirements)
- ✅ Use real FHEVM (not Mock)
- ✅ Use `euint32`/`euint64` types
- ✅ Gateway integration (complete decryption workflow)
- ✅ Deploy to Zama network (Sepolia supported)
- ✅ Open source code (GitHub)

### Should-Have (Important)
- ✅ Solve real-world problem
- ✅ Complete UI/UX
- ✅ Comprehensive documentation
- ✅ Demo video

### Nice-to-Have (Bonus)
- ✅ Innovation in application scenario
- ✅ High code quality
- ✅ Test coverage

---

## 🔧 Common Solutions Quick Reference

### Issue: OKX Wallet Not Popup
**Solution**: Section 6.2 → Use `window.ethereum.request` with explicit `from`

### Issue: Transaction Confirmation Timeout
**Solution**: Section 6.3 → Use public RPC polling instead of wallet provider

### Issue: Gateway Decryption Timeout
**Solution**: Section 10.3 → Implement async processing + retry mechanism

### Issue: eth_call Hanging
**Solution**: Section 6.4 → Use public RPC for all read operations

### Issue: BigInt Conversion Error
**Solution**: Section 6.5 → Use `Number(bigint.toString())`

---

**Last Updated**: 2025-01-XX  
**Manual Version**: 6.1  
**Project Phase**: Development

---

## 📋 问题解决工作流示例

**示例：遇到 "ambiguous function description" 错误**

1. ✅ **第一步：查阅手册**
   ```javascript
   codebase_search(
     query: "ambiguous function description ABI error",
     target_directories: ["FHEVM_开发标准与解决方案手册.md"]
   )
   ```
   
2. ✅ **找到解决方案**：手册第12.3 A节 - 动态ABI配置
   
3. ✅ **实施解决方案**：根据手册修改代码
   
4. ✅ **更新日志**：如果手册中没有，解决后更新手册或调试日志

**记住**：先查手册，再动手！

